<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>砖瓦集——Java Thread | 十二进制</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Thread开始的地方jdk 1.0起存在的两个类：Thread和Runnable，是java 1.0开始提供给用户代码使用线程的方式。Thread基础操作系统的进程与线程计算机硬件资源包括寄存器、CPU、主存、IO设备，操作系统负责管理计算机硬件资源。操作系统具有三大基本抽象：文件（抽象了IO设备）、虚存抽象（抽象了主存和磁盘IO设备）、进程抽象（抽象了处理器和虚存）。应用程序以进程的方式运行，"><meta name="keywords" content="Java,线程"><meta property="og:type" content="article"><meta property="og:title" content="砖瓦集——Java Thread"><meta property="og:url" content="https://f-12.github.io/Hexo/2019/05/10/砖瓦集——Java-Thread/index.html"><meta property="og:site_name" content="十二进制"><meta property="og:description" content="Thread开始的地方jdk 1.0起存在的两个类：Thread和Runnable，是java 1.0开始提供给用户代码使用线程的方式。Thread基础操作系统的进程与线程计算机硬件资源包括寄存器、CPU、主存、IO设备，操作系统负责管理计算机硬件资源。操作系统具有三大基本抽象：文件（抽象了IO设备）、虚存抽象（抽象了主存和磁盘IO设备）、进程抽象（抽象了处理器和虚存）。应用程序以进程的方式运行，"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2019-05-10T15:38:32.681Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="砖瓦集——Java Thread"><meta name="twitter:description" content="Thread开始的地方jdk 1.0起存在的两个类：Thread和Runnable，是java 1.0开始提供给用户代码使用线程的方式。Thread基础操作系统的进程与线程计算机硬件资源包括寄存器、CPU、主存、IO设备，操作系统负责管理计算机硬件资源。操作系统具有三大基本抽象：文件（抽象了IO设备）、虚存抽象（抽象了主存和磁盘IO设备）、进程抽象（抽象了处理器和虚存）。应用程序以进程的方式运行，"><link rel="alternate" href="/atom.xml" title="十二进制" type="application/atom+xml"><link rel="icon" href="/favicon.png"><link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/Hexo/css/style.css"></head></html><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/Hexo/" id="logo">十二进制</a></h1></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"></a> <a class="main-nav-link" href="/Hexo/">Home</a> <a class="main-nav-link" href="/Hexo/archives">Archives</a></nav><nav id="sub-nav"><a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a> <a id="nav-search-btn" class="nav-icon" title="Search"></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://f-12.github.io/Hexo"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-砖瓦集——Java-Thread" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/Hexo/2019/05/10/砖瓦集——Java-Thread/" class="article-date"><time datetime="2019-05-10T12:53:40.000Z" itemprop="datePublished">2019-05-10</time></a></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">砖瓦集——Java Thread</h1></header><div class="article-entry" itemprop="articleBody"><h1 id="Thread开始的地方"><a href="#Thread开始的地方" class="headerlink" title="Thread开始的地方"></a>Thread开始的地方</h1><p>jdk 1.0起存在的两个类：<code>Thread</code>和<code>Runnable</code>，是java 1.0开始提供给用户代码使用线程的方式。</p><h1 id="Thread基础"><a href="#Thread基础" class="headerlink" title="Thread基础"></a>Thread基础</h1><p><strong>操作系统的进程与线程</strong><br>计算机硬件资源包括寄存器、CPU、主存、IO设备，操作系统负责管理计算机硬件资源。操作系统具有三大基本抽象：文件（抽象了IO设备）、虚存抽象（抽象了主存和磁盘IO设备）、进程抽象（抽象了处理器和虚存）。</p><p>应用程序以进程的方式运行，应用程序的视角下：</p><ul><li>独占处理器</li><li>独占虚拟地址空间</li></ul><p>操作系统启动后需要常驻内存，所以进程的虚拟地址空间分为两种：</p><ul><li>内核地址空间（所有进程共享，但应用程序不可访问）</li><li>用户地址空间</li></ul><p>用户地址空间分区：</p><ul><li>环境变量区</li><li>命令行参数区</li><li>栈</li><li>内存映射段</li><li>堆</li><li>BSS段（未初始化的全局变量和静态局部变量）</li><li>Data段（已初始化的全局变量和静态局部变量）</li><li>Text段（存放应用程度代码）</li><li>保留区</li></ul><p>进程和线程区别：</p><ul><li>进程是操作系统资源分配的基本单位，进程间的地址空间是隔离的</li><li>线程是CPU调度的基本单位，线程间共享进程的地址空间</li></ul><p>进程调度和线程调度区别：</p><ul><li>进程调度切换上下文时包括：寄存器、程序状态字、用户地址空间（加载新程序的代码到Text段，初始化Data段和BSS段）</li><li>线程调度切换上下文只有：寄存器、程序状态字、用户地址空间的栈区域<br>因而线程切换消耗比进程切换消耗少。</li></ul><p><strong>JVM进程与Thread</strong><br>jvm进程：</p><ul><li>执行java命令启动一个jvm进程</li><li>jvm通过Thread类提供应用程序使用线程资源的能力</li><li>jvm调度用户线程即执行Thread对象的过程</li></ul><p>jvm调度线程终止条件：</p><ul><li>调用System.exit</li><li>所有用户线程结束（正常执行结束或异常结束）</li></ul><p>daemon：</p><ul><li>Thread分为用户线程和守护线程</li><li>主线程为用户线程</li><li>启动线程前调用<code>Thread#setDaemon</code>创建守护线程</li><li>守护线程在jvm进程退出时结束</li></ul><p>Thread ID：</p><ul><li>每个线程创建时自动分配一个自增的Thread ID</li></ul><p>Thread Name：</p><ul><li>创建线程时可以为线程命名</li><li>匿名线程会按照默认策略生成一个“Thread-<number>“的名字</number></li></ul><p>优先级：</p><ul><li>线程的优先级影响jvm调度线程的情况</li></ul><h1 id="Thread对象"><a href="#Thread对象" class="headerlink" title="Thread对象"></a>Thread对象</h1><p><strong>Thread类</strong><br>Thread类里的关键成员分类：</p><ul><li>核心数据结构：name、匿名线程序列号、priority、daemon</li><li>与调度器交互：start、yield、run、sleep、alive</li><li>与其他线程交互：suspend（弃用）、resume（弃用）、join、interrupt</li><li>与对象锁交互：holdsLock、wait、notify</li><li>与线程组相关：activeCount、enumerate</li><li>ThreadLocal相关：threadLocals、inheritableThreadLocals</li><li>调试相关：</li></ul><p><strong>ThreadLocal类</strong></p><ul><li>每个代表线程的Thread对象里存在包访问的ThreadLocalMap实例</li><li>ThreadLocal通过维护Thread里的ThreadLocalMap给每个线程维护一个变量的副本</li><li>ThreadLocal实现了 Thread Confine Pattern</li></ul><p><strong>ThreadLocalMap类</strong></p><ul><li>ThreadLocalMap是一个用Entry数组实现的hash map</li><li>每个Entry都是继承WeakReference&lt;ThreadLocal&lt;?&gt;&gt;的弱引用，所以当ThreadLocal#set(null)时该变量可以被gc回收</li><li>向ThreadLocalMap增加项时可能rehash</li><li>rehash时先清除不用的值再考虑数组加倍</li></ul><p><strong>创建线程的两种方法</strong></p><ul><li>创建Thread的子类</li><li>使用Runnable对象实例化Thread对象</li></ul><p><strong>阻塞线程的方法</strong></p><ul><li>调用<code>Thread#sleep()</code></li><li>调用<code>Thread#yield()</code>方法让出资源</li><li>调用阻塞方法</li><li>调用同步方法申请锁</li><li>等待<code>notify</code></li><li>调用<code>suspend</code>方法</li><li>被JVM调度</li></ul><p><strong>线程生命周期</strong></p><ul><li>调用<code>new Thread</code>时，线程处于新建态</li><li>调用<code>Thead#start()</code>方法，线程处于就绪态</li><li>调用<code>Thead#run()</code>方法（由JVM调用），线程处于运行态</li><li>调用<code>Thread#stop()</code>方法，线程处于死亡态</li><li>调用<code>Thread#sleep()</code>或<code>Thread#yield()</code>方法，或阻塞方法、或申请锁、或等待通知、或调用<code>suspend</code>方法、或者被JVM调度释放时，线程处于阻塞态</li></ul><p><strong>Runnable</strong><br>jdk对此接口的定位为：</p><blockquote><p>This interface is designed to provide a common protocol for objects that wish to execute code while they are active.</p></blockquote><p>关于<code>Runnable</code>接口的两个正确用法：</p><ul><li>用<code>Runnable</code>实例来创建线程避免创建<code>Thread</code>子类的方式</li><li><code>Runnable</code>实例的生命周期应该和执行时间一直，执行结束就被销毁</li></ul><h1 id="基于Thread-Runnable的多线程编程"><a href="#基于Thread-Runnable的多线程编程" class="headerlink" title="基于Thread/Runnable的多线程编程"></a>基于Thread/Runnable的多线程编程</h1><p>利用线程编程时，基本的场景是：开启一个线程执行某个任务，执行过程中监测到不符合条件的状态阻塞线程从而让出CPU，当条件改变满足继续执行时唤起线程继续执行。</p><p>下面代码展示了使用<code>Thread</code>的<code>suspend</code>和<code>resume</code>完成这个场景的方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> condition = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"do part 1"</span>);</span><br><span class="line">            <span class="keyword">if</span>(!condition) &#123; Thread.currentThread().suspend(); &#125;</span><br><span class="line">            System.out.println(<span class="string">"do part 2"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        t.start();</span><br><span class="line">        System.out.println(<span class="string">"do something"</span>);</span><br><span class="line">        condition = <span class="keyword">true</span>;</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>); <span class="comment">// 移除这行代码，可能resume比suspend先执行</span></span><br><span class="line">        t.resume();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是由于设计上的缺陷，执行时<code>resume</code>必须在<code>suspend</code>之后执行，且成对出现，才能正确执行。但并没有可以保证<code>resume</code>在<code>suspend</code>之后执行的方法，所以这对API很难保证使用正确，容易导致线程假死。</p><h2 id="被弃用的stop"><a href="#被弃用的stop" class="headerlink" title="被弃用的stop"></a>被弃用的<code>stop</code></h2><p><code>stop</code>在终止线程时会强制中断线程的执行，并且还会释放这个线程持有的所有的锁对象。这一现象会被其它因为请求锁而阻塞的线程看到，使他们继续向下执行，可能就会造成数据的不一致。</p><p><strong>例子</strong> 从A账户向B账户转账X元这一过程有三步操作，第一步是从A账户中减去X元，假如到这时线程就被stop了，那么这个线程就会释放它所取得锁，然后其他的线程继续执行，这样A账户就莫名其妙的少了X元而B账户也没有收到钱</p><h2 id="被弃用的suspend-resume"><a href="#被弃用的suspend-resume" class="headerlink" title="被弃用的suspend/resume"></a>被弃用的<code>suspend</code>/<code>resume</code></h2><p><code>suspend</code>阻塞线程时不会释放线程持有的锁。因此存在两种情况：</p><ul><li>A 获得锁X后suspend，B需要获得锁X后才能resume A，造成死锁</li><li>没有可以保证<code>resume</code>在<code>suspend</code>之后执行的方法，线程可能假死</li></ul></div><footer class="article-footer"><a data-url="https://f-12.github.io/Hexo/2019/05/10/砖瓦集——Java-Thread/" data-id="cjvj9vo7a000bqex0o1tevj92" class="article-share-link">Share</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/Hexo/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/Hexo/tags/线程/">线程</a></li></ul></footer></div><nav id="article-nav"><a href="/Hexo/2019/05/10/砖瓦集——Java-Thread-Pool/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">砖瓦集——Java Thread Pool</div></a><a href="/Hexo/2019/04/28/微服务监控告警——实现篇/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">微服务监控告警——实现篇</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/ALert/">ALert</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/Javascript/">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/Lock/">Lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/Monitoring/">Monitoring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/Prometheus/">Prometheus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/RabbitMQ/">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/Spring/">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/SpringBootAdmin/">SpringBootAdmin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/Vue/">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/fork/">fork</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/join/">join</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/webpack/">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/告警/">告警</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/并发/">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/微服务/">微服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/插件体系/">插件体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/源码分析/">源码分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/监控/">监控</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/线程/">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/线程池/">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/Hexo/tags/锁/">锁</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/Hexo/tags/ALert/" style="font-size:10px">ALert</a> <a href="/Hexo/tags/Java/" style="font-size:17.5px">Java</a> <a href="/Hexo/tags/Javascript/" style="font-size:10px">Javascript</a> <a href="/Hexo/tags/Lock/" style="font-size:10px">Lock</a> <a href="/Hexo/tags/Monitoring/" style="font-size:17.5px">Monitoring</a> <a href="/Hexo/tags/Prometheus/" style="font-size:12.5px">Prometheus</a> <a href="/Hexo/tags/RabbitMQ/" style="font-size:10px">RabbitMQ</a> <a href="/Hexo/tags/Spring/" style="font-size:10px">Spring</a> <a href="/Hexo/tags/SpringBootAdmin/" style="font-size:10px">SpringBootAdmin</a> <a href="/Hexo/tags/Vue/" style="font-size:10px">Vue</a> <a href="/Hexo/tags/Web/" style="font-size:10px">Web</a> <a href="/Hexo/tags/fork/" style="font-size:10px">fork</a> <a href="/Hexo/tags/javascript/" style="font-size:10px">javascript</a> <a href="/Hexo/tags/join/" style="font-size:10px">join</a> <a href="/Hexo/tags/webpack/" style="font-size:10px">webpack</a> <a href="/Hexo/tags/告警/" style="font-size:10px">告警</a> <a href="/Hexo/tags/并发/" style="font-size:12.5px">并发</a> <a href="/Hexo/tags/微服务/" style="font-size:20px">微服务</a> <a href="/Hexo/tags/插件体系/" style="font-size:10px">插件体系</a> <a href="/Hexo/tags/源码分析/" style="font-size:10px">源码分析</a> <a href="/Hexo/tags/监控/" style="font-size:15px">监控</a> <a href="/Hexo/tags/线程/" style="font-size:17.5px">线程</a> <a href="/Hexo/tags/线程池/" style="font-size:10px">线程池</a> <a href="/Hexo/tags/锁/" style="font-size:10px">锁</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/Hexo/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/Hexo/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/Hexo/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/Hexo/archives/2016/09/">September 2016</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/Hexo/2019/05/11/砖瓦集——Java并发编程演变史/">砖瓦集——Java并发编程演变史</a></li><li><a href="/Hexo/2019/05/11/砖瓦集——Java-Fork-Join/">砖瓦集——Java Fork/Join</a></li><li><a href="/Hexo/2019/05/11/砖瓦集——Java-Lock/">砖瓦集——Java Lock</a></li><li><a href="/Hexo/2019/05/10/砖瓦集——Java-Thread-Pool/">砖瓦集——Java Thread Pool</a></li><li><a href="/Hexo/2019/05/10/砖瓦集——Java-Thread/">砖瓦集——Java Thread</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2019 F-12<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/Hexo/" class="mobile-nav-link">Home</a> <a href="/Hexo/archives" class="mobile-nav-link">Archives</a></nav><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="stylesheet" href="/Hexo/fancybox/jquery.fancybox.css"><script src="/Hexo/fancybox/jquery.fancybox.pack.js"></script><script src="/Hexo/js/script.js"></script></div></body>