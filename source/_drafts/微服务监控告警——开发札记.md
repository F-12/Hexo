---
title: 微服务监控告警——开发札记
toc: true
tags:
---

# 概述

`Big Picture`如下图所示：

{% asset_img monitoring-solution.png %}


涉及的具体工作如下：
- 开发 alert manager
- 开发 redis metrics exporter
- 开发 service metrics exporter
- 开发 health monitor
- 开发 performance metrics client
- 接入 kafka 监控
- 接入 sring boot admin
- 配置 Grafana Dashboard
- 配置 Azure Dashboard

# Alert Manager

alert manager主要负责实现两部分功能：
- [x] grafana 和 webex teams 的桥接
- [x] splunk 和 webex teams 的桥接
- [x] alert 处理流程的管理

## grafana 和 webex teams 的桥接
```puml
@startuml
participant Grafana as G
participant Prometheus as P 
participant Webex as W 
participant Alert_Manager as A 

G -> P: retrieve metrics
G -> A: alert webhook
A -> A: create alert
A -> W: send alert message to alert room
@enduml
```

## splunk 和 webex teams 的桥接
```puml
@startuml
participant Splunk as S 
participant Webex as W 
participant Alert_Manager as A 

S -> W: alert webhook
W -> A: alert webhook
A -> A: create alert
A -> W: send alert message to alert room
@enduml
```

## alert 处理流程的管理
webex room接收到alert后，开发可以直接与alert room bot进行交互，对alert进行管理。

目前支持的管理命令：
- `alert list`
- `alert process <ID>`
- `alert ignore <ID>`
- `alert finish <ID>`

```puml
@startuml
participant Webex as W 
participant Alert_Manager as A 
participant Programmer as P

A -> W: send an alert message with id
P -> W: send an alert managment command
W -> A: command webhook
A --> W: command handle response
W ->> P: alert management command response
@enduml
```


# Redis Metrics Exporter
使用 [Redis Keyspace Notification](https://redis.io/topics/notifications) 监听
Redis Metrics Exporter 主要实现一下功能

- 


# Service Metrics Exporter

Service Metrics Exporter的功能包括：
- [ ] 桥接 Prometheus 和 PCF Internal Service
- [ ] 基于 Eureka 的 指标聚合
- [ ] 提供单一 Endpoint 供 Prometheus Scraper 消费

```puml
@startuml
participant Prometheus as P
participant Service_Metrics_Exporter as SE
participant Eureka as E
participant ServiceX as SX


loop N times
    SX -> E: register
    E -> SX: health check
end

SE -> E: retrieve service list periodly

P -> SE: scrape metrics

loop N times
    SE -> SX: retrieve metrics endpoint
end

SE -> SE: aggregate metrics

SE --> P: aggregated metrics

@enduml
```

# Health Monitor
Health Monitor 主要负责两个功能：
- [ ] 定期调用外部依赖服务检测其接口可用性
- [ ] 将检测结果定义为 spring boot actuator metrics 集成到 `／actuator/metrics`，供Service Metrics Exporter聚合使用

```puml
@startuml
participant Service_Metrics_Exporter as SE
participant Health_Monitor as HM
participant External_API as EX


HM -> EX: check periodly
HM -> HM: calculate metrics
SE -> HM: retrieve health metrics
HM --> SE: health metrics

@enduml
```

需要解决的问题：
1. [ ] check health 阶段，如何处理事务类请求
1. [ ] calculate metrics 参考proemtheus的metrics类型设计metrics计算方式
1. [ ] retrieve health metrics 阶段，如何使用spring boot actuator自定义metrics将 health metrics 集成到 `/actuator/metircs` endpoint下

# Performance Metrics Client


# 其他
**kafka 监控**

- [ ] 业务服务引入 micrometer kafka jar

**sring boot admin**

- [ ] 业务服务引入 spring boot actuator jar
- [x] 部署spring boot admin server

**Grafana Dashboard**

- [ ] 确定需要的dashboard类型
- [ ] 配置 Grafana Dashboard
- [ ] 配置 Alert Rule
- [ ] 确定合适的 Alert Metrics Threshold

**SQL Server监控**
- [ ] Azure Dashboard for SQL Server

**MongoDB监控**

- [ ] Azure Dashboard for MongoDB