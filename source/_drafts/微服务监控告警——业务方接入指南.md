title: 微服务监控告警——业务方接入指南
toc: true
thumbnail: /images/banner.jpg
nanoid: n-z-J2EtL-WvfiE7VT1WH
tags:
---

本文用来指导业务服务接入监控平台。

<!-- more -->

# 概述

业务服务接入时包括如下如下功能的接入：
- spring boot actuator admin 接入
- prometheus metrics 接入
- performance metrics 接入
- kafka metrics 接入

# 引入依赖包

修改`build.gradle`，增加如下包：
```
dependencies {
	// Monitor
    // spring-boot-actuator cllient
	compile("org.springframework.boot:spring-boot-starter-actuator")

    // micrometer
    compile 'io.micrometer:micrometer-registry-prometheus:latest.release'

    // PCF Eureka
    compile("io.pivotal.spring.cloud:spring-cloud-services-starter-service-registry")

    // Performance
    compile("com.ford.besl.monitoring:performance-metrics-client")
    // ...
}
```

`com.ford.besl.monitoring:performance-metrics-client`需要使用AOP开发对应的二方jar。

# 配置

**`application.yml`**

```
management:
  endpoints:
    web:
      exposure:
        include: auditevents,conditions,configprops,env,health,info,integrationgraph,loggers,liquibase,metrics,mappings,threaddump,heapdump,logfile,prometheus
        exclude: shutdown
  endpoint:
    health:
      show-details: ALWAYS
```

关于配置的含义参考 [Endpoints](https://docs.spring.io/spring-boot/docs/2.0.3.RELEASE/reference/htmlsingle/#production-ready-endpoints)


**SpringBootApplication**

确保自动扫描的路径中包括了`com.ford.besl.monitoring`。


# Metric 生成
## Performance Metrics
定义接口时在 `RestController`上增加 `@Timed`注解

```java
@RestController
@Timed
public class MyController {

	@GetMapping("/api/people")
	@Timed(extraTags = { "region", "us-east-1" }) 2
	public List<Person> listPeople() { ... }

}
```

`@Timed`注解开启对接口性能进行测量，通过`extraTags`增加自定义属性。


## 自定义Metric
**micrometer**

参考 [Metrics](https://docs.spring.io/spring-boot/docs/2.0.3.RELEASE/reference/htmlsingle/#production-ready-metrics-getting-started)了解spring如何集成micrometer-registory。

了解micrometer中不同类型的metric。
- [Counters](https://micrometer.io/docs/concepts#_counters)
- [Gauges](https://micrometer.io/docs/concepts#_gauges)
- [Timers](https://micrometer.io/docs/concepts#_timers)
- [DistributionSummary](https://micrometer.io/docs/concepts#_distribution_summaries)

**自定义metric实现**  

比如需要自定义一个 `Counter` 可以使用如下方式：

```java
@Component
public class SampleBean {

	private final Counter counter;

	public SampleBean(MeterRegistry registry) {
		this.counter = registry.counter("received.messages");
	}

	public void handleMessage(String message) {
		this.counter.increment();
		// handle message implementation
	}

}
```

## 监控Metric
- 使用 Grafana 的 portal界面定义查询的 PromQL，参考 [QUERYING PROMETHEUS](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- 使用 Grafana 的 portal界面定义 AlertRule，参考 [Alert Engines & Rules Guide](https://grafana.com/docs/alerting/rules/)





# 安全策略

**内部服务** 使用 contain-to-container方式，走内网流程

**网关服务** 配置用户名和密码