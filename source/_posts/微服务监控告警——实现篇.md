---
title: 微服务监控告警——实现篇
date: 2019-04-28 17:14:13
tags:
    - Monitoring
    - 监控
    - 微服务
---

# 背景
功能篇里描述了我们的监控告警系统需要具备的基本能力。围绕这些基本能力，我们需要制定一个可以实现的方案。


# 健康监控

健康监控选择使用spring-boot-actuator配合spring-boot-admin实现。  
具体可以参见 {% post_link 微服务监控告警——使用SpringBootAdmin对服务进行实时可视化管理.md %}

# 资源监控

资源监控部分的工具选择为：
- 使用spring-boot-actuator作为metrics采集器
- 使用micrometer将actuator metrics转换为prometheus可以使用的metrics
- 使用prometheus作为存储引擎和查询引擎
- 使用grafana作为可视化工具

## 业务微服务引入spring-boot-actuator

`build.gradle`中增加依赖：
```groovy

dependencies {
	// monitor
	compile("org.springframework.boot:spring-boot-starter-actuator")

    // ...
}
```

`application.yml`增加配置：

```YAML
management:
  endpoints:
    web:
      exposure:
        include: auditevents,conditions,configprops,env,health,info,integrationgraph,loggers,liquibase,metrics,mappings,threaddump,heapdump,logfile,prometheus
        exclude: shutdown
  endpoint:
    health:
      show-details: ALWAYS
```

对`actuator` endpoints配置security policy。

TBD

访问 `<HOSTNAME>/actuator` 验证actuator端点, 成功的情况下会出现如下列表：
```json
{
"_links": {    
{"self":{"href":"https://<HOSTNAME>/actuator","templated":false},"auditevents":{"href":"https://<HOSTNAME>/actuator/auditevents","templated":false},"health-component-instance":{"href":"https://<HOSTNAME>/actuator/health/{component}/{instance}","templated":true},"health":{"href":"https://<HOSTNAME>/actuator/health","templated":false},"health-component":{"href":"https://<HOSTNAME>/actuator/health/{component}","templated":true},"conditions":{"href":"https://<HOSTNAME>/actuator/conditions","templated":false},"configprops":{"href":"https://<HOSTNAME>/actuator/configprops","templated":false},"env":{"href":"https://<HOSTNAME>/actuator/env","templated":false},"env-toMatch":{"href":"https://<HOSTNAME>/actuator/env/{toMatch}","templated":true},"info":{"href":"https://<HOSTNAME>/actuator/info","templated":false},"loggers":{"href":"https://<HOSTNAME>/actuator/loggers","templated":false},"loggers-name":{"href":"https://<HOSTNAME>/actuator/loggers/{name}","templated":true},"heapdump":{"href":"https://<HOSTNAME>/actuator/heapdump","templated":false},"threaddump":{"href":"https://<HOSTNAME>/actuator/threaddump","templated":false},"prometheus":{"href":"https://<HOSTNAME>/actuator/prometheus","templated":false},"metrics-requiredMetricName":{"href":"https://<HOSTNAME>/actuator/metrics/{requiredMetricName}","templated":true},"metrics":{"href":"https://<HOSTNAME>/actuator/metrics","templated":false},"mappings":{"href":"https://<HOSTNAME>/actuator/mappings","templated":false}}
}}
```

## 业务微服务引入micrometer

`build.gradle`中增加依赖：
```groovy

dependencies {
	// monitor
    compile 'io.micrometer:micrometer-registry-prometheus:latest.release'

    // ...
}
```

`application.yml`的`management.endpoints.web.exposure`增加`prometheus`。

访问`https://<HOSTNAME>/actuator/prometheus`验证，成功情况下应该出现如下内容：
```text
# HELP system_cpu_count The number of processors available to the Java virtual machine
# TYPE system_cpu_count gauge
system_cpu_count 4.0
# HELP process_uptime_seconds The uptime of the Java virtual machine
# TYPE process_uptime_seconds gauge
process_uptime_seconds 347.673
# HELP jvm_gc_memory_allocated_bytes_total Incremented for an increase in the size of the young generation memory pool after one GC to before the next
# TYPE jvm_gc_memory_allocated_bytes_total counter
jvm_gc_memory_allocated_bytes_total 7.6690036E8
# HELP process_files_open_files The open file descriptor count
# TYPE process_files_open_files gauge
process_files_open_files 123.0
# HELP tomcat_global_error_total  
# TYPE tomcat_global_error_total counter
tomcat_global_error_total{name="http-nio-8080",} 6.0
...
```

## Prometheus配置增加业务服务的job

Prometheus无法和部署在PCF上的Eureka集成，因而选择在一台可以访问公网的HOST上部署prometheus-server。并对每个按照上述部署的微服务增加对应的抓取指标的JOB配置。

```YAML
scrape_configs:
  - job_name: 'actuator-client'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 15s
    static_configs:
    - targets: ['<HOSTNAME>']

# ...
```
重启prometheus-server后可以在prometheus提供的简易web界面上调试，验证自己的微服务的指标数据是否能够成功抓取。

## 配置业务服务的Grafana监控大盘

TBD




