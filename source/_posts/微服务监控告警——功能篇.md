---
title: 微服务监控告警——功能篇
date: 2019-04-28 15:39:31
tags:
    - Monitoring
    - 监控
    - 微服务
---

# 背景
目前我们的项目采用了基于Spring Cloud的微服务架构。微服务数目随着业务功能的扩展持续增加。我们需要监控各个微服务在生产环境的运行状况，在出现异常时收到报警，以便及时跟进处理。  

项目的基本情况如下：
- 部署在Pivotal Cloud Foundry平台
- 使用的PCF提供的基于Eureka的服务注册中心
- 使用PCF提供的Redis服务实例
- 使用PCF提供的RabbitMQ服务实例
- 使用部署在Azure上的SQL Server
- 使用部署在Azure上的MongoDB
- 包含十几个自主开发的微服务
- 生产环境的服务输出的log会统一收集到splunk中
- 项目成员使用Webex Teams作为沟通工具

# 目标

1. 构建一个监控告警系统
2. 确定监控内容
3. 确定告警策略


# 方案
## 监控部分

### 健康监控

生产环境可能存在多个不同服务，每个服务可能存在多个节点。我们的项目使用了Eureka作为服务注册中心，Eureak本身会包含已注册微服务的心跳数据。

对于这种现状，我们的监控系统需要能够做到：
- 告诉我们哪些服务正在运行，哪些服务已经宕机。  
- 告诉我们每个服务各自有多少节点
- 告诉我们每个服务的多个节点里有几个正在运行、有几个已经宕机。
- 最好可以和Eureka集成或使用Eureka中的注册信息。
- 以上信息必须可以通过可视化大盘展示

### 环境监控

生产环境的微服务可能运行在Host中、VM中或者云平台的容器中。微服务会依赖宿主运行环境中的CPU资源、内存资源、磁盘资源。我们的微服务运行在PCF平台的容器中，这些资源在服务启动时指定，目前没有使用弹性资源策略。

当微服务在生产环境运行时，对这些资源的动态信息，我们的监控系统需要能够做到：
- 展示最大CPU资源数及当前CPU占用率
- 展示最大内存资源数及当前内存已使用量
- 展示最大磁盘资源数及当前磁盘已使用量

除了宿主环境的资源信息，我们的微服务都使用java开发，针对jvm的情况，我们的监控系统还需要做到：
- 展示jvm的堆内存最大量及已使用量
- 展示jvm的栈内存最大量及已使用量
- 展示jvm内线程活跃数、空闲数、总线程数等信息
- 展示jvm gc次数，full gc次数，gc耗时等信息

### RabbitMQ监控

项目中使用了RabbitMQ，针对RabbitMQ，我们的监控系统需要能够做到：
- 展示当前已存在的Exchange总数
- 展示当前已存在的Queue总数
- 展示当前建立到RabbitMQ的连接数
- 展示每个queue当前排队待处理的message数目
- 展示每个Exchange上绑定的queue的数目
- 展示每个queue上的consumers数目
- 展示每个queue占用的内存大小


### Redis监控
项目中使用了Redis。针对Redis，我们的监控系统需要能够做到：
- 展示Redis的客户端数目
- 每秒执行的Command数目
- 每秒接受的Command数目
- 总内存大小
- 已使用内存大小随时间的变化
- 网络吞吐量
- 每个节点存储的key的数目

### 资源监控
#### SQL Server
SQL Server需要监控的内容如下：
- DTU Max，Used，Percentage
- Successful Connections Percentage
- 连接数max，usage，percentage

TBD

#### MongoDB
MongoDB监控内容：
- Disk Max，Usage
- 连接数Max，Usage

TBD

#### 性能监控
性能监控能力主要包括两部分：自身服务接口响应性能和外部服务调用的响应性能。  
针对服务响应性能需要收集一下指标：
- 平均每秒请求数
- 平均接口响应时间
- TP90接口响应时间
- TP95接口响应时间
- TP99接口响应时间


## 告警部分
### 监控指标报警
当监控系统能够监控到各个微服务健康状态，运行环境的资源状态已经特定中间件的运行状态等不同指标信息后，我们的监控系统需要能够为每个指标指定一个告警策略。

- 比如当宿主环境CPU占用率在最近的5分钟持续高于90%
- 比如过去2小时full gc发生次数大于10
- 比如redis已使用内存占用率超出80%

### 业务异常告警
服务运行时不可避免会出现业务异常。通常我们会使用log来输出异常信息。我们的项目使用splunk收集服务的log信息，因而我们系统需要能够利用利用splunk的搜索功能，在log信息中出现exception信息时，通过webex teams通知到服务负责人。

### 告警处理流程
我们希望的开发处理告警的流程为：
- Alert Channel收到Alert
- Alert类型包括Exception Alert、Metrics Alert
- Exception Alert内容包含Alert Id，Exception描述信息，Exception来自哪个服务，Exception来自哪个环境（Stage、Prod），Splunk Exception Log链接
- Metrics Alert内容包括Alert Id，Alert Rule Id， Alert Rule Name，Alert Rule Message，Alert Metrics当前具体值
- 开发开始处理alert时，在Channel中发送： @AlertBot processing #<Alert Id> 
- Alert静默半小时
- 开发处理完Alert后，在Channel中发送： @AlertBot finished #<Alert Id>
- 重新打开该类型的alert



